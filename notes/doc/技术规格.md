# Synnia v3.0 - 技术规格说明书 (Technical Specifications)

> 本文档定义了 Synnia v3.0 的技术架构、数据结构和实现标准。

## 1. 架构概览 (Architecture Overview)

Synnia 采用 **Metadata-Driven (元数据驱动)** + **Local-First (本地优先)** 架构。

*   **核心理念**:
    *   **Registry as DNA**: 资产定义、属性、配方全部由 JSON Registry 驱动，而非硬编码。
    *   **Asset as Data**: 节点是数据的容器，UI 只是数据的渲染器。
*   **技术栈**:
    *   Frontend: React 19, TypeScript, Zustand, ReactFlow.
    *   Backend: Tauri v2 (Rust).
    *   AI: Google Gemini API.

## 2. 数据结构 (SPF v3.0)

### 2.1 通用资产数据 (AssetData)

```typescript
export interface AssetData {
  id: string;
  assetType: string; // 开放字符串，对应 Registry 中的 key
  
  // 核心属性包 (KV Store)
  // 不再有固定的 content/src 字段，一切皆属性
  properties: {
    name: string;
    description?: string;
    tags?: string[];
    content?: string; // 文本内容
    src?: string;     // 图片路径
    [key: string]: any; // 动态字段 (HP, MP, LoraWeights...)
  };

  status: 'idle' | 'processing' | 'success' | 'error' | 'stale';
  
  // 血统 / 溯源
  provenance?: {
    recipeId: string;
    generatedAt: number;
    sources: { nodeId: string; nodeVersion: number }[];
    paramsSnapshot: Record<string, any>;
  };
}
```

### 2.2 注册表结构 (Registry Schema)

```json
{
  "types": {
    "character": {
      "extends": "base_asset",
      "mixins": ["rpg_stats"],
      "properties": {
        "avatar": { "type": "image" }
      }
    }
  },
  "mixins": {
    "rpg_stats": {
      "properties": {
        "hp": { "type": "number", "default": 100 }
      }
    }
  },
  "recipes": { ... }
}
```

## 3. 关键实现逻辑

### 3.1 Mixin (组合逻辑)
*   **Deep Merge**: 当应用 Mixin 时，系统执行属性的深度合并。
*   **Tags Union**: Tags 数组取并集。

### 3.2 版本控制 (Versioning)
*   **Update Strategy**: 原地更新 (In-place Update)。
    *   `version` 字段 +1。
    *   旧数据存入 `history` (Optional) 或仅依赖 Provenance 追溯。
*   **Stale Propagation**: 递归查找图中的下游节点（通过 `provenance.sourceNodeIds`），比对 `currentVersion` vs `recordedVersion`。

### 3.3 渲染器 (Universal Renderer)
*   `AssetNode.tsx` 不再包含业务逻辑。
*   它遍历 `data.properties`，根据 Registry 定义的 `ui_widget` (e.g., `image_preview`, `slider`, `markdown`) 渲染对应组件。

## 4. 文件系统

```text
MyProject/
├── synnia.json      # 核心图数据库
├── assets/          # 媒体文件仓储
└── registry.json    # (Optional) 项目级自定义 Registry
```

## 5. 废弃特性 (Deprecations)

*   **SQLite**: 已移除。
*   **Hardcoded Asset Types**: 所有的 `switch (type)` 逻辑应逐渐替换为 Registry 查找。