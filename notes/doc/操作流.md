# Synnia v3.0 - 用户操作流文档 (User Operations Flow)

> **核心哲学**: 画布上只有资产（名词），线就是功能（动词）。用户不需要是程序员，只需要像整理桌面一样整理节点，像连线搭积木一样生产内容。

---

## 1. 项目生命周期 (Project Lifecycle)

Synnia 是本地优先的文件系统应用。

*   **新建**: 创建文件夹 `MyProject/` 及 `synnia.json`。
*   **打开**: 加载本地文件夹，内存中恢复画布状态。
*   **保存**: `Ctrl+S` 将内存状态快照写入磁盘。所有编辑操作（移动、连线）均为纯内存操作，无 IO 延迟。

---

## 2. 资产创建 (Creation)

### 2.1 画布空白处右键菜单
当用户在画布空白处右键时，弹出以下层级菜单：

1.  **新建资产 >**
    *   **简单文本** (`text_asset`): 生成便签节点，内容为空。
    *   **提示词** (`prompt_asset`): 生成专用文本节点，含正/负向输入区。
    *   **媒体/文档 >**
        *   **图片**: 弹出对话框（Name, Path Picker）。确定后生成节点。
        *   **视频/音频/文档**: 同上。
    *   **自定义对象** (`struct_asset`): 弹出动态表单构建器。
        *   用户定义字段名和类型。
        *   支持递归添加子字段（如包含图片的 Character Sheet）。
        *   *延迟校验*: 创建时若必填项为空，节点显示红框（Invalid）。
    *   **空集合** (`collection_asset`): 弹出配置对话框。
        *   *配置*: 名称、最大容量、Tag 约束（白名单）。
    *   *(分割线)*
    *   **模板 (自带Tag) >**: 动态加载的预设列表。
        *   例如 "角色卡": 自动创建带有 `Role` Tag 和 `character_stats` Mixin 的节点。

### 2.2 动态筛选规则 (Dynamic Query)
集合节点不仅是物理容器，还是智能视图。
*   **配置**: 用户可为集合设置规则（如 `Tag == "WIP" AND Type == "Image"`）。
*   **行为**: 集合自动抓取画布上所有符合条件的资产，生成**虚线快捷方式**放入集合。

---

## 3. 资产交互 (Interaction)

### 3.1 选中资产右键菜单
用户右键点击已存在的资产节点：

1.  **✨ 重新制作 (Remake)** *(条件: 有 Provenance)*
    *   逻辑: 使用上次的配方和参数重新运行。
    *   结果: 生成新版本 (v+1)，覆盖当前节点数据（历史存入 Provenance）。
    *   *连锁反应*: 下游依赖此节点的产物自动标记为 **黄色 (Stale)**。
2.  **⚗️ 可用配方 >** *(动态生成)*
    *   逻辑: 遍历 Registry，显示所有接受当前节点类型（或 Key）的配方。
    *   多选支持: 若同时选中图片+文本，显示接受多输入的配方（如 "Img2Img + Prompt"）。
3.  *(分割线)*
4.  **🔗 创建快捷方式**: 鼠标变为连线状态，点击目标集合放入。
5.  **📂 加入集合 >**: 列出当前画布上的集合，点击直接加入。
6.  **🧪 Mixin (注入能力) >**: 列出可用 Mixin。
    *   逻辑: **深度合并 (Deep Merge)**。
    *   *例子*: 给 "高中生" Mixin "特工" -> Tags 合并，字段叠加。
    *   *嵌套*: 给 "特工" Mixin "背包" -> 节点增加 `inventory` 字段（指向一个内嵌集合）。
7.  *(分割线)*
8.  **👁️ 视图**: 折叠/展开、最大化。
9.  **📝 编辑**: 复制、粘贴、重命名、删除。

### 3.2 拖拽与整理
*   **拖入集合**: 物理移动。节点从画布顶层消失，进入集合内部（或被视觉包裹）。
*   **Ctrl + 拖入集合**: 创建快捷方式（引用）。原节点保留，集合内增加虚线链接。
*   **拖到空白处**:
    *   如果是从集合里拖出来 -> 移出集合。
    *   如果是 `Ctrl+拖` -> 询问 "创建快捷方式到新集合?"。

---

## 4. 生产与连线 (Wiring & Production)

### 4.1 连线交互 (The Linear Flow)
1.  **拖出连线**: 从资产 A 的输出端口拖出一根线。
2.  **松开 (Drop)**:
    *   **在空白处**: 弹出 "可用配方" 菜单。
        *   选择配方 -> 系统自动创建结果节点 B -> 运行 Agent -> B 显示进度条 -> B 显示结果。
    *   **在现有节点 B 上**:
        *   如果 B 是空的/兼容的 -> 询问 "作为输入运行配方?"
3.  **多输入**:
    *   配方需要 Image + Prompt。
    *   用户分别将 Image 和 Prompt 连线到同一个 "Processing" 节点，配方自动触发。

### 4.2 版本控制 (Consistency Engine)
*   **Stale State (过时)**: 当上游节点 A 更新（v1 -> v2）时，所有由 A 生成的下游节点 B、C 自动变为 **黄色边框**。
*   **Batch Update (批量更新)**: 用户框选所有黄框节点 -> 右键 "重制选中项" -> 系统按依赖顺序依次刷新。

---

## 5. 配方协议 (Recipe Protocol)

*   **匹配**: 基于字段 Key（如 `text`, `src`）或资产类型 (`image_asset`)。
*   **执行**: 异步运行。Agent 返回进度事件，前端更新 UI。
*   **输出**: 严格的 JSON 结构，前端据此渲染新节点。

---

## 6. 快捷键

| 按键 | 功能 |
| --- | --- |
| `Space` (Hold) | 拖拽画布 (Hand) |
| `V` | 选择工具 |
| `Ctrl + S` | 保存 |
| `Ctrl + Z / Y` | 撤销 / 重做 |
| `Delete` | 删除 |
| `Ctrl + D` | 复制 (Duplicate) |
