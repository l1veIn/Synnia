# Synnia 工作流重构指导

> 本次重构的核心目标：**提供更多种类的节点来支持工作流的复杂度**

---

## 1. 重构背景

### 1.1 当前问题

- Handle 命名分散，语义混乱
- 节点分类不清晰
- Edge 类型单一，无法区分"数据流"与"产出关系"
- 缺少集合类型节点支持复杂工作流

### 1.2 重构目标

为后续**工作流模板**功能做铺垫：
- 工作流 = N 个配方节点 + M 个资产节点
- 预设工作流可导入，自带默认资产内容
- 用户可自由编辑和扩展

---

## 2. 核心设计原则

> **节点类型 ← 交互模式 ← 人与数据的关系**

### 2.1 数据流架构：Pull-Based

只有**配方节点执行**时才触发数据流动：

```
┌─────────┐    ┌─────────┐    ┌─────────┐
│  Text   │    │  Table  │    │ Selector│   ← 被动数据源
└────○────┘    └────○────┘    └────○────┘
     └──────────────┼──────────────┘
                    ↓
            ┌──────────────┐
            │ Recipe Node  │   ← 主动消费者
            │   [▶ 执行]   │
            └──────────────┘
```

### 2.2 节点分类

| 分类 | 节点 | 定位 | 输入端口 | 数据来源 |
|------|------|------|----------|----------|
| **边缘节点** | Text / Image | 原子数据容器 | ❌ 无 | 用户编辑 |
| **集合节点** | Selector / Table / Gallery / Queue | 集合数据容器 | ❌ 无 | 用户交互 |
| **配方节点** | Recipe | 执行单元 | ✅ 有 | 上游连接 |

> **关键决策**：集合节点定位为**重编辑**。预设数据通过工作流导入时的**资产内容**提供，而非输入端口。

---

## 3. Handle 规范

### 3.1 语义分类

| 语义 | ID 模式 | 用途 |
|------|---------|------|
| `DATA_OUT` | `text-out`, `json-out`, `selected` | 节点输出数据 |
| `DATA_IN` | `field:xxx` | 配方接收数据 |
| `PRODUCT` | `product` | 配方产出结果 |
| `ORIGIN` | `origin` | 被生成节点的来源标记 |

### 3.2 标准 Handle 表

| 节点 | Handle ID | 位置 | 方向 | 数据类型 |
|------|-----------|------|------|----------|
| Text | `text-out` | Bottom | source | text |
| Image | `image-out` | Bottom | source | image |
| JSON | `json-out` | Right | source | json |
| Selector | `selected` | Bottom | source | array |
| Table | `rows` | Bottom | source | array |
| Gallery | `images` | Bottom | source | array |
| Recipe | `field:xxx` | Left | target | any |
| Recipe | `product` | Bottom | source | any |
| Generated | `origin` | Top | target | - |

### 3.3 TypeScript 定义

```typescript
// src/types/handles.ts

export enum HandleSemantic {
  DATA_IN = 'data-in',
  DATA_OUT = 'data-out',
  ORIGIN = 'origin',
  PRODUCT = 'product',
}

export enum HandleDataType {
  TEXT = 'text',
  IMAGE = 'image',
  JSON = 'json',
  ARRAY = 'array',
  ANY = 'any',
}

export interface HandleDefinition {
  id: string;
  semantic: HandleSemantic;
  dataType: HandleDataType;
  position: 'top' | 'bottom' | 'left' | 'right';
  direction: 'source' | 'target';
}
```

---

## 4. Edge 类型扩展

### 4.1 两种连线

| 类型 | 语义 | 样式 | 创建方式 |
|------|------|------|----------|
| **Data Edge** | 数据流 | 实线 | 用户拖拽 |
| **Output Edge** | 产出关系 | 虚线 (紫色) | 配方执行后自动 |

### 4.2 视觉对比

```
     实线 = 数据输入
         ↓
┌────────○────────┐
│  Selector Node  │
└────────○────────┘
         │
         ▼ 实线
┌────────○────────┐
│  Recipe Node    │
└────────◇────────┘
         ┊
         ┊ 虚线 = 产出
         ▽
┌────────◇────────┐
│ Generated Text  │
└─────────────────┘
```

---

## 5. 新增节点类型

### 5.1 Selector Node ⭐⭐⭐⭐⭐

**核心交互**: 选择、筛选

**节点 UI**:
```
┌──────────────────────────────┐
│  📋 资产定义库         🔍    │
├──────────────────────────────┤
│  ☑️ character-main   [主视觉]│
│  ☑️ ui-kit-core      [核心UI]│
│  ☐ sticker-pack     [表情包]│
│  已选: 2/10     [全选] [清空]│
└──────────────────○───────────┘
                   ↓ selected[]
```

**输出**: `selected` (array), `single` (json)

**Inspector 属性面板**:
```
┌─────────────────────────────────┐
│ Selector 设置                   │
├─────────────────────────────────┤
│ 标题: [资产定义库________]      │
│                                 │
│ 模式: ◉ 多选  ○ 单选            │
│                                 │
│ ☑ 显示搜索框                    │
│ ☐ 允许添加自定义项               │
│                                 │
├─────────────────────────────────┤
│ 选项列表                 [+ 添加]│
│ ┌───────────────────────────┐   │
│ │ id: character-main        │   │
│ │ label: 主视觉             │   │
│ │ description: 核心角色形象  │   │
│ └─────────────────── [删除] ┘   │
│ ┌───────────────────────────┐   │
│ │ id: ui-kit-core           │   │
│ │ label: 核心UI             │   │
│ └─────────────────── [删除] ┘   │
└─────────────────────────────────┘
```

**Inspector 交互**:
- 标题编辑：修改节点标题
- 模式切换：单选/多选，影响输出格式
- 选项列表：可视化编辑所有选项，支持增删改
- 每个选项可折叠展开编辑详细字段

---

### 5.2 Table Node ⭐⭐⭐⭐

**核心交互**: 表格编辑

**节点 UI**:
```
┌─────────────────────────────────┐
│  📊 配置表              [+行]   │
├──────┬──────────┬───────────────┤
│  ID  │   类型   │     标签      │
├──────┼──────────┼───────────────┤
│  1   │ ui-kit   │   核心UI      │
│  2   │ poster   │   海报        │
└──────┴──────────┴───────○───────┘
                          ↓ rows[]
```

**输出**: `rows` (array)

**Inspector 属性面板**:
```
┌─────────────────────────────────┐
│ Table 设置                      │
├─────────────────────────────────┤
│ 标题: [配置表___________]       │
│                                 │
│ ☑ 显示行号                      │
│ ☑ 允许排序                      │
│ ☑ 允许添加行                    │
│ ☐ 允许删除行                    │
│                                 │
├─────────────────────────────────┤
│ 列定义                   [+ 添加]│
│ ┌───────────────────────────┐   │
│ │ key: type                 │   │
│ │ label: 类型               │   │
│ │ type: ▼ string            │   │
│ │ width: [100] px           │   │
│ └─────────────────── [删除] ┘   │
│ ┌───────────────────────────┐   │
│ │ key: label                │   │
│ │ label: 标签               │   │
│ │ type: ▼ string            │   │
│ └─────────────────── [删除] ┘   │
├─────────────────────────────────┤
│ 数据预览 (JSON)                 │
│ ┌───────────────────────────┐   │
│ │ [{"type":"ui-kit",...}]   │   │
│ └───────────────────────────┘   │
└─────────────────────────────────┘
```

**Inspector 交互**:
- 列定义编辑：定义表格结构（key、label、类型、宽度）
- 列类型：string / number / boolean / select
- 数据预览：只读 JSON 视图，方便调试
- 行数据的编辑在节点内直接操作

---

### 5.3 Gallery Node ⭐⭐⭐⭐

**核心交互**: 图片预览、收藏

**节点 UI**:
```
┌────────────────────────────────┐
│  🖼️ 生成结果           [网格▼] │
├────────────────────────────────┤
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐  │
│  │ 📷⭐│ │ 📷 │ │ 📷⭐│ │ 📷 │  │
│  └────┘ └────┘ └────┘ └────┘  │
│  已选: 2张                      │
└───○────────────────────○───────┘
    ↓ images[]           ↓ starred[]
```

**输出**: `images` (array), `starred` (array)

**Inspector 属性面板**:
```
┌─────────────────────────────────┐
│ Gallery 设置                    │
├─────────────────────────────────┤
│ 标题: [生成结果_________]       │
│                                 │
│ 视图模式: ◉ 网格  ○ 列表  ○ 大图 │
│                                 │
│ 每行数量: [4] 张                │
│                                 │
│ ☑ 允许标星收藏                  │
│ ☑ 允许删除图片                  │
│ ☐ 允许拖拽排序                  │
│                                 │
├─────────────────────────────────┤
│ 图片管理                        │
│ ┌───────────────────────────┐   │
│ │ 共 8 张图片                │   │
│ │ ⭐ 已标星: 2 张            │   │
│ │                           │   │
│ │ [清空全部] [取消所有标星]    │   │
│ └───────────────────────────┘   │
├─────────────────────────────────┤
│ 导入图片              [+ 从文件] │
│                       [+ 从URL] │
└─────────────────────────────────┘
```

**Inspector 交互**:
- 视图配置：网格/列表/大图切换
- 每行数量：控制网格密度
- 图片管理：批量操作（清空、取消标星）
- 导入图片：从文件或 URL 添加图片

---

### 5.4 Queue Node ⭐⭐⭐

**核心交互**: 任务队列管理

**节点 UI**:
```
┌────────────────────────────────┐
│  📋 生成队列          [▶ 开始] │
├────────────────────────────────┤
│  1. ✅ 主视觉生成        完成  │
│  2. 🔄 UI Kit 生成    进行中...│
│  3. ⏳ 表情包生成        等待  │
│  进度: 1/3                     │
└───○────────────────────○───────┘
    ↓ tasks[]            ↓ results[]
```

**输出**: `tasks` (array), `results` (array)

**Inspector 属性面板**:
```
┌─────────────────────────────────┐
│ Queue 设置                      │
├─────────────────────────────────┤
│ 标题: [生成队列_________]       │
│                                 │
│ 并发数: [1] (1-5)               │
│                                 │
│ ☐ 自动开始                      │
│ ☑ 失败时重试                    │
│   重试次数: [3]                 │
│ ☐ 失败后继续执行                 │
│                                 │
├─────────────────────────────────┤
│ 队列状态                        │
│ ┌───────────────────────────┐   │
│ │ 状态: 运行中               │   │
│ │ 进度: 2/5                  │   │
│ │ 已完成: 1                  │   │
│ │ 失败: 0                    │   │
│ │                           │   │
│ │ [暂停] [重置] [清空结果]    │   │
│ └───────────────────────────┘   │
├─────────────────────────────────┤
│ 执行历史                 [清空] │
│ ┌───────────────────────────┐   │
│ │ #1 主视觉 ✅ 2.3s         │   │
│ │ #2 UI Kit 🔄 运行中...    │   │
│ └───────────────────────────┘   │
└─────────────────────────────────┘
```

**Inspector 交互**:
- 并发配置：控制同时执行的任务数
- 重试策略：失败处理方式
- 队列状态：实时显示运行状态
- 执行历史：查看每个任务的执行结果和耗时

---

## 6. 实现计划

### 6.1 优先级

1. **Handle 规范化** — 统一现有节点的 handle
2. **Edge 类型扩展** — 区分数据流和产出关系
3. **Selector Node** — 最急需
4. **Gallery Node** — 展示生成结果
5. **Table Node** — 批量编辑
6. **Queue Node** — 批量执行

### 6.2 架构统一

所有节点需遵循：
- 使用 `NodeShell` + `NodeHeader`
- 使用 `useNode` hook
- 定义 `outputs` resolver
- 提供 `Inspector` 组件

---

## 7. 未来方向

| 节点类型 | 交互模式 | 应用场景 |
|----------|----------|----------|
| Tree Node | 层级展开 | 嵌套结构 |
| Timeline Node | 历史回溯 | 版本记录 |
| Canvas Node | 自由画布 | 图片标注 |
